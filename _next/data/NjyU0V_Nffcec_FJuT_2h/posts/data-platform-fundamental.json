{"pageProps":{"slug":"data-platform-fundamental","postData":{"id":"data-platform-fundamental","contentHtml":"<h1 id=\"overview\">Overview</h1>\n<p>本記事ではデータプラットフォームを構築する場合に知っておくべき基本的な概念について整理する。</p>\n<p>シニアエグゼクティグなどが「データ分析をするために DWH を構築する」と言ったときに、実際には何が欲しいのか。\nおそらく特定のユースケースのデータマートで、いくつかの KPI を見たい場合が多いと思うがエンジニアリング視点ではデータマートを構築するためにはいくつかのステップが必要。\nエンジニア側と各ステークホルダーの理解を合わせる必要があるため、本記事は単語や概念の理解の齟齬をなくすために使えるメモとして作る。</p>\n<h1 id=\"dwh-構築にあたってまず考えるもの\">DWH 構築にあたってまず考えるもの</h1>\n<h2 id=\"ユニバーサル言語\">ユニバーサル言語</h2>\n<p>DDD と同様にデータ処理環境構築においても非エンジニアを含むステークホルダーと開発するエンジニアで共通言語を保つ必要がある。</p>\n<h3 id=\"データソース\">データソース</h3>\n<p>オリジナルデータやデータの発生源のこと。</p>\n<ul>\n<li>各アプリケーションの OLTP 用の RDB</li>\n<li>Webs サーバーのログ</li>\n<li>スクレイピングなどを行う外部のデータ</li>\n</ul>\n<h3 id=\"データレイク\">データレイク</h3>\n<p>多様なデータを集約する場所。データソースのデータをそのままコピーしたデータや置き場を指す。\n加工や結合をしておらず、データソースと 1 対 1 であるべき。</p>\n<ul>\n<li>販売情報など</li>\n<li>GCS などのオブジェクトストレージに置く事が多い</li>\n</ul>\n<h3 id=\"データウェアハウス\">データウェアハウス</h3>\n<p>DWH と表現することが多い。加工・結合したデータの置き場を指す。\nより多くの情報に基づく意思決定を行うための分析可能なデータの集中管理場所。</p>\n<ul>\n<li>売上情報サマリーなど</li>\n<li>BigQuery や Hadoop など大規模なデータを高速に処理可能な基盤に置く</li>\n</ul>\n<h3 id=\"データマート\">データマート</h3>\n<p>加工・結合したデータの置き場。特定用途向けのデータ、またその置き場を指す。\n複数のチャネルでの売上データをアグリゲーションし作った統合価格テーブルなど。</p>\n<ul>\n<li>DWH から必要な情報を抽出した View</li>\n<li>DWH からデータを抽出して RDB に挿入したもの</li>\n</ul>\n<h3 id=\"データパイプライン\">データパイプライン</h3>\n<p>データソースから取得したデータを DWH やデータマートに格納する過程で、ETL <sup><a href=\"#user-content-fn-etl\" id=\"user-content-fnref-etl\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\">1</a></sup> などを用いて情報収集・蓄積・加工・抽出などを行う一連のフローのこと。\nデータ処理のワークフロー。</p>\n<h3 id=\"バッチ処理\">バッチ処理</h3>\n<p>大量のデータを一度に処理するために定期的に実行する処理。</p>\n<h3 id=\"ストリーム処理\">ストリーム処理</h3>\n<p>データの発生時点でリアルタイムに加工・抽出・保存などを行う処理。</p>\n<h3 id=\"その他ドメイン独自の用語\">その他ドメイン独自の用語</h3>\n<p>EC なら Product や Order、SaaS なら MAU、MRR、Churn など業務ドメイン独自の単語が出てくるので、これらも認識をあわせるべき。</p>\n<p>例えば商品配送のことを Shipment と表現したり Fulfillment と表現することが有るが、これらは同じものなのか、利用する場面や背景が異なるのかがわからない。\nエンジニア側とステークホルダー側で用語ごとの認識合わせを行うべき。</p>\n<p><img src=\"https://storage.googleapis.com/gweb-cloudblog-publish/images/6_5xBiker.0999056719991134.max-2000x2000.jpg\" alt=\"DWH アーキテクチャのイメージ図\" title=\"DWH アーキテクチャのイメージ\">\n[図 1: <code>Google Cloud の導入を促進する 13 のサンプル アーキテクチャ</code><sup><a href=\"#user-content-fn-gcpdata\" id=\"user-content-fnref-gcpdata\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\">2</a></sup>より]</p>\n<h2 id=\"crud-表\">CRUD 表</h2>\n<p>データの出入り口を理解するために CRUD 表を作ると良い</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th align=\"center\"></th><th align=\"center\">社外</th><th align=\"center\">社外</th><th align=\"center\">社内</th><th align=\"center\">社内</th><th align=\"center\">社内</th><th align=\"center\">社内</th></tr></thead><tbody><tr><td align=\"center\"></td><td align=\"center\">競合 A</td><td align=\"center\">比較サイト</td><td align=\"center\">EC サイト</td><td align=\"center\">調達</td><td align=\"center\">マーケティング</td><td align=\"center\">経理</td></tr><tr><td align=\"center\">商品</td><td align=\"center\">CUD</td><td align=\"center\">CU</td><td align=\"center\">CRU</td><td align=\"center\">R</td><td align=\"center\">R</td><td align=\"center\">R</td></tr><tr><td align=\"center\">価格</td><td align=\"center\">CU</td><td align=\"center\">CU</td><td align=\"center\">CRU</td><td align=\"center\">R</td><td align=\"center\">R</td><td align=\"center\">R</td></tr><tr><td align=\"center\">在庫</td><td align=\"center\">CU</td><td align=\"center\"></td><td align=\"center\">CRU</td><td align=\"center\">R</td><td align=\"center\">R</td><td align=\"center\"></td></tr><tr><td align=\"center\">クーポン</td><td align=\"center\"></td><td align=\"center\"></td><td align=\"center\">R</td><td align=\"center\"></td><td align=\"center\">C</td><td align=\"center\">R</td></tr></tbody></table>\n<h2 id=\"組織を超えたコラボレーション\">組織を超えたコラボレーション</h2>\n<p>データの生成者と利用者でお互いにフィードバックを与えられる文化を醸成する必要がある。</p>\n<ul>\n<li>データの生成者は提供するデータで有用だと思えるのに活用されていないものを伝える</li>\n<li>データの利用者は足りないデータを生成するよう伝える</li>\n</ul>\n<h1 id=\"各レイヤーで気をつけるべきポイント\">各レイヤーで気をつけるべきポイント</h1>\n<h2 id=\"データソースレイヤー\">データソースレイヤー</h2>\n<p>オリジナルデータやその発生源。EC サイトなら購買履歴などの OLTP の DB などを指し、外部のデータなら API を提供しているサービスやスクレイピングする対象の Web サイトを指す。</p>\n<h3 id=\"データソースの品質\">データソースの品質</h3>\n<h4 id=\"garbage-in-garbage-out\">Garbage in, garbage out</h4>\n<ul>\n<li>この段階でデータがダメだとその先持つ買い物にならない</li>\n<li>必要なデータが無いとそもそも分析できない</li>\n</ul>\n<p>データの品質はデータソースで確保する必要があり、下流(データ利用者)から上流(データ提供者)へフィードバックする必要がある。</p>\n<h4 id=\"データの生成過程を知る\">データの生成過程を知る</h4>\n<p>データがどのような形で作られているのか理解する。\n同じようなデータでも精度が異なる場合や、リアルタイムなのか一定時間毎に更新されるのかという点が異なる場合があり、データの信頼性に影響する。</p>\n<p>業務のフローを理解することも重要で、ユーザーストーリーなどを確認し(作成し)、業務中での登場人物や各ステップで行うこと、生成されるデータを書き出すと良い。</p>\n<h3 id=\"特に管理するべきデータ\">特に管理するべきデータ</h3>\n<h4 id=\"マスタデータ\">マスタデータ</h4>\n<p>同じものを指すのに入力者やデータ取得元が違うと異なる表現になるとデータの利用が難しくなる。\n部署やアプリケーションを横断して表記の差異が無いようにマスタデータの管理が必要。</p>\n<p>このマスタデータは全体で共有の ID で運用される必要がある。</p>\n<h4 id=\"履歴データ\">履歴データ</h4>\n<p>データが上書きされるとある時点での状態がわからなくなる。</p>\n<p>データ分析チームや、カスタマーサポート、監査やリーガルなどのチームでは履歴情報が重要。\n特にマスタデータの場合は削除や更新するのではなく、バージョニングするべき。</p>\n<h2 id=\"データレイクレイヤー\">データレイクレイヤー</h2>\n<p>データレイクは元のデータをコピーして一つのシステムに集約したもの。</p>\n<p>形式はオブジェクトストレージに保存するか、分析用 DB に保存することが多い。</p>\n<h3 id=\"データの加工をしない\">データの加工をしない</h3>\n<p>データレイクレイヤーでは分析用に集計しなりせず、何も加工していないのが重要。仮に中身に誤りがあっても修正や加工をせずそのまま集約する。</p>\n<ul>\n<li>分析の視点が変わったときにデータが無いことを防ぐ</li>\n<li>加工していた場合データが間違っているときに元データが間違っているのか、加工時点で間違えたのかがわからなくなる</li>\n</ul>\n<h3 id=\"同一箇所に作る\">同一箇所に作る</h3>\n<p>データレイクを複数箇所に作るのはバッドプラクティス</p>\n<ul>\n<li>コピーされたデータとコピーされてないデータの管理が難しい</li>\n<li>処理の変更があった場合に複数箇所の変更が必要</li>\n<li>チームや組織を横断したデータの活用が行いやすい</li>\n</ul>\n<h2 id=\"dwh-レイヤー\">DWH レイヤー</h2>\n<p>分析対象の指標などのデータやその置き場。</p>\n<ul>\n<li>DWH は全体の SSOT <sup><a href=\"#user-content-fn-ssot\" id=\"user-content-fnref-ssot\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\">3</a></sup> として共通の ID を用いて、同一箇所で運用するべき</li>\n<li>指標の基準をあわせる\n<ul>\n<li>売上は税込みか税抜きか</li>\n<li>利益マージンの計算方法</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"dwh-構築時の処理\">DWH 構築時の処理</h3>\n<p>DWH の構築は何段階かの処理を経て実現される。</p>\n<h4 id=\"データクレンジング\">データクレンジング</h4>\n<p>データソース (データレイク) のデータは完全な状態でなかったり、複数の データソースを参照する場合に表記が異なる事がある。</p>\n<p>データクレンジングでは主に以下のような処理を行う。</p>\n<ul>\n<li>欠損データ埋め</li>\n<li>重複削除</li>\n<li>データの名寄せ・共通化</li>\n</ul>\n<h4 id=\"ディメンショナルデータモデリング\">ディメンショナルデータモデリング</h4>\n<p>ディメンショナルデータモデリングではスノーフレーク・スキーマやスター・スキーマと呼ばれるような形でスキーマを定義し、データを保持する。\nこの段階により、多次元分析で行われる軸の入れ替えやドリルダウン＆ドリルアップ、次元のスライスといった操作を可能にする。</p>\n<p>例えば次の時間軸や地域を次の例のように分割することで分析の粒度を調整しやすくなる。</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>year</th><th align=\"center\">quarter</th><th align=\"center\">month</th><th align=\"center\">day</th></tr></thead><tbody><tr><td>2022</td><td align=\"center\">Q1</td><td align=\"center\">2</td><td align=\"center\">13</td></tr><tr><td>2022</td><td align=\"center\">Q1</td><td align=\"center\">3</td><td align=\"center\">14</td></tr></tbody></table>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>country</th><th align=\"center\">prefecture</th><th align=\"center\">city</th><th align=\"center\">area</th></tr></thead><tbody><tr><td>Japan</td><td align=\"center\">Tokyo</td><td align=\"center\">Minato</td><td align=\"center\">Akasaka</td></tr><tr><td>Japan</td><td align=\"center\">Tokyo</td><td align=\"center\">Shibuya</td><td align=\"center\">Yoyogi</td></tr></tbody></table>\n<h4 id=\"指標のアグリゲーション\">指標のアグリゲーション</h4>\n<p>DWH では年月や商品、場所、そのた属性情報などのディメンションデータを用いて指標の集計を行う。</p>\n<p>部署によって用途が異なるデータはデータマート層で扱うのが良いが、売上などのチームを横断して共通の指標は DWH 層で扱うと良い。</p>\n<h2 id=\"データマートレイヤー\">データマートレイヤー</h2>\n<p>データマートとは、特定の利用者や用途向けに加工・整理したデータやその置き場を指すし、基本的にデータのユースケースと一対一となる。</p>\n<p>DWH を構築出来るほど業務知識が体系化されていない場合には、データレイクをさんしょうしてデータマートを作り、DWH の早すぎる最適化を防ぐ方法もある。</p>\n<h2 id=\"ユースケースごとにデータマート作る\">ユースケースごとにデータマート作る</h2>\n<ol>\n<li>影響範囲を制限する\n<ul>\n<li>新たなデータソースを使ったり、ユースケースを使うときに他へ影響を気にしたくない</li>\n</ul>\n</li>\n<li>パフォーマンス\n<ul>\n<li>利用するデータを絞ることで影響範囲を制限する</li>\n<li>事前に必要な集計処理を行う</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ユースケース\">ユースケース</h2>\n<p>ここでのユースケースはデータ基盤を用いたデータの用途を指す。ユースケースには以下のような例がある。</p>\n<ul>\n<li>売上高、在庫状態、販売・仕入れ、利益マージン・広告コストなどの KPI モニタリング</li>\n<li>商談開始から契約完了までの状態</li>\n<li>機能開発や、AB テストの結果の計測</li>\n<li>売買と地域性の分析</li>\n<li>アプリケーションログを用いたユーザー解析</li>\n<li>障害発生時の影響範囲特定</li>\n</ul>\n<h3 id=\"ユースケースの計画\">ユースケースの計画</h3>\n<p>以下のポイントを考慮してデータを処理するためにユースケースを事前に計画する。</p>\n<ul>\n<li>データの必要なタイミング\n<ul>\n<li>バッチ処理でよいのか、ストリーム処理が必要なのか</li>\n</ul>\n</li>\n<li>データを用いて何を見たいのか、どんな意思決定をしたいのか</li>\n<li>データ利用の 5W1H を予め想定する</li>\n</ul>\n<h1 id=\"参考\">参考</h1>\n<p>全体</p>\n<ul>\n<li><a href=\"https://amzn.to/3q1V4xl\">実践的データ基盤への処方箋〜 ビジネス価値創出のためのデータ・システム・ヒトのノウハウ</a></li>\n<li><a href=\"https://aws.amazon.com/jp/data-warehouse/\">データウェアハウスの概念</a></li>\n<li><a href=\"https://services.google.com/fh/files/misc/bring-data-lakes-and-data-warehouses-together.pdf\">Converging Architectures: Bringing Data Lakes and Data Warehouses Together</a></li>\n<li><a href=\"https://cloud.google.com/architecture/build-a-data-lake-on-gcp\">データレイクとしての Cloud Storage</a></li>\n</ul>\n<p>ディメンショナルモデリング</p>\n<ul>\n<li><a href=\"https://www.ibm.com/docs/ja/opw/8.2.0?topic=models-dimensional-data-model\">ディメンショナル・データ・モデル - IBM</a></li>\n<li><a href=\"https://docs.microsoft.com/ja-jp/power-bi/guidance/star-schema\">スター スキーマと Power BI での重要性を理解する</a></li>\n</ul>\n<section data-footnotes=\"\" class=\"footnotes\"><h2 id=\"footnote-label\" class=\"sr-only\">Footnotes</h2>\n<ol>\n<li id=\"user-content-fn-etl\">\n<p>Extract, Transform, Load <a href=\"#user-content-fnref-etl\" data-footnote-backref=\"\" class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-gcpdata\">\n<p><a href=\"https://cloud.google.com/blog/ja/products/application-development/13-popular-application-architectures-for-google-cloud\">https://cloud.google.com/blog/ja/products/application-development/13-popular-application-architectures-for-google-cloud</a> <a href=\"#user-content-fnref-gcpdata\" data-footnote-backref=\"\" class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-ssot\">\n<p>Single Source Of Trust <a href=\"#user-content-fnref-ssot\" data-footnote-backref=\"\" class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n</ol>\n</section>","title":"データ処理基盤に関わる基本概念","date":"2022-03-13","tags":["engineering","data","dwh"],"description":"データ処理基盤を構築するために必要な基礎知識の整理","published":true}},"__N_SSG":true}